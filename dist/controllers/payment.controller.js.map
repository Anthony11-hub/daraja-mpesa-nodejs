{"version":3,"file":"payment.controller.js","sourceRoot":"/","sources":["controllers/payment.controller.ts"],"names":[],"mappings":"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","sourcesContent":["import { prisma } from \"../config/db\";\nimport { RequestHandler } from \"express\";\nimport axios from \"axios\";\nimport { ValidationError } from \"../error/validation.error\";\nimport { AppError } from \"../error/app.error\";\nimport { utils } from \"../utils\";\n\n// stk push\nexport const stkPush: RequestHandler = async (req, res, next) => {\n  const { phone, amount } = req.body;\n\n  if (!phone || typeof phone !== \"string\") {\n    throw new ValidationError(\"Invalid phone number\", \"Invalid phone number\");\n  }\n\n  if (!amount || typeof amount !== \"number\" || amount <= 0) {\n    throw new ValidationError(\"Invalid amount\", \"Invalid amount\");\n  }\n\n  const date = new Date();\n\n  const timestamp =\n    date.getFullYear() +\n    (\"0\" + (date.getMonth() + 1)).slice(-2) +\n    (\"0\" + date.getDate()).slice(-2) +\n    (\"0\" + date.getHours()).slice(-2) +\n    (\"0\" + date.getMinutes()).slice(-2) +\n    (\"0\" + date.getSeconds()).slice(-2);\n\n  const config = {\n    headers: {\n      Accept: \"application/json\",\n      Authorization: `Bearer ${req.token}`,\n    },\n  };\n\n  const shortcode = process.env.MPESA_SHORTCODE;\n  const passkey = process.env.MPESA_PASSKEY;\n\n  if (!shortcode || !passkey) {\n    throw new AppError(\n      \"Payment configuration error\",\n      \"Shortcode or passkey not provided\",\n      500,\n    );\n  }\n\n  const password = Buffer.from(shortcode + passkey + timestamp).toString(\n    \"base64\",\n  );\n\n  const normalizedPhone = phone.startsWith(\"0\")\n    ? `254${phone.slice(1)}`\n    : phone;\n\n  if (!/^2547\\d{8}$/.test(normalizedPhone)) {\n    throw new ValidationError(\n      \"Invalid phone format\",\n      \"Phone format provided is invalid\",\n    );\n  }\n\n  const body = {\n    BusinessShortCode: shortcode,\n    Password: password,\n    Timestamp: timestamp,\n    TransactionType: \"CustomerPayBillOnline\",\n    Amount: amount,\n    PartyA: `254${normalizedPhone}`,\n    PartyB: shortcode,\n    PhoneNumber: `254${phone.substring(1)}`,\n    CallBackURL: `${process.env.MPESA_CALLBACK_URL}/${process.env.MPESA_CALLBACK_SECRET_KEY}`,\n    AccountReference: `254${phone.substring(1)}`,\n    TransactionDesc: \"sale purchase\",\n  };\n\n  let response;\n\n  try {\n    response = await axios.post(\n      \"https://api.safaricom.co.ke/mpesa/stkpush/v1/processrequest\",\n      body,\n      config,\n    );\n  } catch (err: any) {\n    const mpesaMessage =\n      err.response?.data?.errorMessage ||\n      err.response?.data?.ResponseDescription ||\n      \"Failed to initiate payment\";\n\n    throw new AppError(mpesaMessage, mpesaMessage, 502);\n  }\n\n  const { CheckoutRequestID } = response.data;\n\n  const paymentRef = await utils.generateRef(\"transactions\");\n\n  await prisma.transaction.create({\n    data: {\n      amount,\n      phone,\n      checkoutRequestId: CheckoutRequestID,\n      paymentRef,\n    },\n  });\n\n  return res.status(200).json({\n    message: \"STK push initiated\",\n    checkoutRequestId: CheckoutRequestID,\n  });\n};\n// callback\nexport const callback: RequestHandler = async (req, res, next) => {\n  try {\n    const callbackData = req.body;\n    // check security key\n    const { securityKey } = req.params;\n\n    if (securityKey !== process.env.MPESA_CALLBACK_SECRET_KEY) {\n      return res.json({ status: \"ok\" });\n    }\n\n    const checkoutRequestId = callbackData.Body.stkCallback.CheckoutRequestID;\n    const mpesaReference =\n      callbackData.Body.stkCallback.CallbackMetadata.Item[1].Value;\n    const resultCode = callbackData.Body.stkCallback.ResultCode;\n\n    // check if payment exists in db - status should be \"pending\"\n    const transaction = await prisma.transaction.findFirst({\n      where: { checkoutRequestId, status: \"pending\" },\n    });\n\n    // The transaction doesn't exist in our db\n    if (!transaction) {\n      return res.json({ status: \"ok\" });\n    }\n\n    // check the result code\n    if (resultCode !== 0) {\n      // Our payment has failed\n      await prisma.transaction.update({\n        where: { id: transaction.id },\n        data: {\n          status: \"failed\",\n        },\n      });\n      return res.json({ status: \"ok\" });\n    }\n\n    // update the payment mpesaRef and status to \"complete\"\n    await prisma.transaction.update({\n      where: { id: transaction.id },\n      data: {\n        mpesaRef: mpesaReference,\n        status: \"complete\",\n      },\n    });\n\n    return res.json({ status: \"ok\" });\n  } catch (error) {\n    return res.json({ status: \"ok\" });\n  }\n};\n// transaction query\nexport const stkQuery: RequestHandler = async (req, res, next) => {\n  const { checkoutRequestId } = req.body;\n\n  if (!checkoutRequestId || typeof checkoutRequestId !== \"string\") {\n    throw new ValidationError(\n      \"Invalid checkoutRequestId\",\n      \"Invalid checkoutRequestId\",\n    );\n  }\n\n  const date = new Date();\n\n  const timestamp =\n    date.getFullYear() +\n    (\"0\" + (date.getMonth() + 1)).slice(-2) +\n    (\"0\" + date.getDate()).slice(-2) +\n    (\"0\" + date.getHours()).slice(-2) +\n    (\"0\" + date.getMinutes()).slice(-2) +\n    (\"0\" + date.getSeconds()).slice(-2);\n\n  const config = {\n    headers: {\n      Accept: \"application/json\",\n      Authorization: `Bearer ${req.token}`,\n    },\n  };\n\n  const shortcode = process.env.MPESA_SHORTCODE;\n  const passkey = process.env.MPESA_PASSKEY;\n\n  if (!shortcode || !passkey) {\n    throw new AppError(\n      \"Payment configuration error\",\n      \"Shortcode or passkey not provided\",\n      500,\n    );\n  }\n\n  const password = Buffer.from(shortcode + passkey + timestamp).toString(\n    \"base64\",\n  );\n\n  const body = {\n    BusinessShortCode: shortcode,\n    Password: password,\n    Timestamp: timestamp,\n    CheckoutRequestID: checkoutRequestId,\n  };\n\n  let response;\n\n  try {\n    response = await axios.post(\n      \"https://api.safaricom.co.ke/mpesa/stkpushquery/v1/query\",\n      body,\n      config,\n    );\n    console.log(response);\n  } catch (err: any) {\n    const mpesaMessage =\n      err.response?.data?.errorMessage ||\n      err.response?.data?.ResponseDescription ||\n      \"Failed to get transaction status\";\n\n    throw new AppError(mpesaMessage, mpesaMessage, 502);\n  }\n\n  return res.status(200).json({\n    message: response.data.ResultDesc,\n    code: response.data.ResultCode,\n  });\n};\n// b2c\n"]}